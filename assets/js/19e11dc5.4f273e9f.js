"use strict";(self.webpackChunkOPS535=self.webpackChunkOPS535||[]).push([[4707],{3905:function(e,o,t){t.d(o,{Zo:function(){return m},kt:function(){return d}});var n=t(7294);function i(e,o,t){return o in e?Object.defineProperty(e,o,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[o]=t,e}function r(e,o){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);o&&(n=n.filter((function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable}))),t.push.apply(t,n)}return t}function a(e){for(var o=1;o<arguments.length;o++){var t=null!=arguments[o]?arguments[o]:{};o%2?r(Object(t),!0).forEach((function(o){i(e,o,t[o])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(o){Object.defineProperty(e,o,Object.getOwnPropertyDescriptor(t,o))}))}return e}function l(e,o){if(null==e)return{};var t,n,i=function(e,o){if(null==e)return{};var t,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)t=r[n],o.indexOf(t)>=0||(i[t]=e[t]);return i}(e,o);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)t=r[n],o.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=n.createContext({}),c=function(e){var o=n.useContext(s),t=o;return e&&(t="function"==typeof e?e(o):a(a({},o),e)),t},m=function(e){var o=c(e.components);return n.createElement(s.Provider,{value:o},e.children)},p={inlineCode:"code",wrapper:function(e){var o=e.children;return n.createElement(n.Fragment,{},o)}},f=n.forwardRef((function(e,o){var t=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),f=c(t),d=i,u=f["".concat(s,".").concat(d)]||f[d]||p[d]||r;return t?n.createElement(u,a(a({ref:o},m),{},{components:t})):n.createElement(u,a({ref:o},m))}));function d(e,o){var t=arguments,i=o&&o.mdxType;if("string"==typeof e||i){var r=t.length,a=new Array(r);a[0]=f;var l={};for(var s in o)hasOwnProperty.call(o,s)&&(l[s]=o[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,a[1]=l;for(var c=2;c<r;c++)a[c]=t[c];return n.createElement.apply(null,a)}return n.createElement.apply(null,t)}f.displayName="MDXCreateElement"},6351:function(e,o,t){t.r(o),t.d(o,{assets:function(){return s},contentTitle:function(){return a},default:function(){return p},frontMatter:function(){return r},metadata:function(){return l},toc:function(){return c}});var n=t(3117),i=(t(7294),t(3905));const r={id:"postfix-spf",title:"Sender Policy Framework",sidebar_position:16,description:"Postfix SPF"},a="Postfix SPF",l={unversionedId:"C-ExtraResources/postfix-spf",id:"C-ExtraResources/postfix-spf",title:"Sender Policy Framework",description:"Postfix SPF",source:"@site/docs/C-ExtraResources/postfix-spf.md",sourceDirName:"C-ExtraResources",slug:"/C-ExtraResources/postfix-spf",permalink:"/OPS535/C-ExtraResources/postfix-spf",draft:!1,editUrl:"https://github.com/Seneca-ICTOER/OERTemplate/tree/main/docs/C-ExtraResources/postfix-spf.md",tags:[],version:"current",sidebarPosition:16,frontMatter:{id:"postfix-spf",title:"Sender Policy Framework",sidebar_position:16,description:"Postfix SPF"},sidebar:"courseNotesSidebar",previous:{title:"SMTP, POP, and IMAP",permalink:"/OPS535/C-ExtraResources/email-protocols-2"},next:{title:"DNS and eMail",permalink:"/OPS535/C-ExtraResources/internet-mail-system"}},s={},c=[{value:"Objective",id:"objective",level:2},{value:"References",id:"references",level:2},{value:"Pre-requisite",id:"pre-requisite",level:2},{value:"Required Packages for checking SPF in Postfix",id:"required-packages-for-checking-spf-in-postfix",level:2},{value:"Tasks",id:"tasks",level:2},{value:"Primary DNS updates - email sender",id:"primary-dns-updates---email-sender",level:2},{value:"MTA configuration updates - email receiver",id:"mta-configuration-updates---email-receiver",level:2},{value:"Examples",id:"examples",level:2},{value:"Messages In root&#39;s Mail Box",id:"messages-in-roots-mail-box",level:2},{value:"MailLog (postfix)",id:"maillog-postfix",level:2}],m={toc:c};function p(e){let{components:o,...t}=e;return(0,i.kt)("wrapper",(0,n.Z)({},m,t,{components:o,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"postfix-spf"},"Postfix SPF"),(0,i.kt)("h2",{id:"objective"},"Objective"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Configure Postfix to check for SPF record and reject spam mails")),(0,i.kt)("h2",{id:"references"},"References"),(0,i.kt)("p",null,"Please read the information provided by the following three links to get a better understanding of basic concept of the Sender Policy Framework (SPF)"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://wiki.centos.org/HowTos/postfix_restrictions"},"Postfix Restriction")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.openspf.org/Project_Overview"},"Sender Policy Framework")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.zytrax.com/books/dns/ch9/spf.html"},"Define an SPF record and examples"))),(0,i.kt)("h2",{id:"pre-requisite"},"Pre-requisite"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Root name server"),(0,i.kt)("li",{parentName:"ul"},"Primary DNS server"),(0,i.kt)("li",{parentName:"ul"},"Caching-only DNS server"),(0,i.kt)("li",{parentName:"ul"},"Postfix installed and configured for your domain")),(0,i.kt)("h2",{id:"required-packages-for-checking-spf-in-postfix"},"Required Packages for checking SPF in Postfix"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},'pypolicyd-spf (from the epel repository, if epel is not enable on your CentOS 7.0 system, you need to run "yum install epel-release" to install it.)'),(0,i.kt)("li",{parentName:"ul"},"pypolicyd-spf depends on python-pydns, python-pyspf, and python-ipaddr packages. All three python modules will be installed if you use yum to install pypolicyd-spf.")),(0,i.kt)("h2",{id:"tasks"},"Tasks"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"update your primary DNS server with SPF record"),(0,i.kt)("li",{parentName:"ul"},"configure your postfix server to check sender address")),(0,i.kt)("h2",{id:"primary-dns-updates---email-sender"},"Primary DNS updates - email sender"),(0,i.kt)("p",null,"Assumption: You own the bigfoot.com domain"),(0,i.kt)("p",null,"You should have the following zone entry in the file /etc/named.conf on your primary DNS server:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'zone "bigfoot.com" IN {\n    type master;\n    file "zone-bigfoot.com";\n};\n')),(0,i.kt)("p",null,"You should have the zone file for your bigfoot.com zone in /var/named directory:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'[root@pri named]# cat zone-bigfoot.com \n$TTL 300\n@ IN SOA pri.cp.net.    root.cp.net. (\n                20151111 ; serial\n                1h     ; refresh\n                15m     ; retry\n                3d     ; expire\n                10m)     ; minimum\n     IN NS    pri.cp.net.\nmail    IN A     192.168.99.1\nbigfoot.com.    IN MX 10    mail.bigfoot.com.\n\nbigfoot.com.    IN TXT "v=spf1 mx -all"\n')),(0,i.kt)("h2",{id:"mta-configuration-updates---email-receiver"},"MTA configuration updates - email receiver"),(0,i.kt)("p",null,"/etc/postfix/master.cf"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"[root@mail ~]# diff /etc/postfix/master.cf /etc/postfix/master.cf.org\n128,131d127\n< # \n< # Add pypolicyd-spf to test for SPF record\n< policyd-spf unix -    n    n    -    0    spawn    user=nobody    argv=/usr/libexec/postfix/policyd-spf\n< \n")),(0,i.kt)("p",null,"/etc/postfix/main.cf"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"[root@mail ~]# diff /etc/postfix/main.cf /etc/postfix/main.cf.org\n113c113\n< inet_interfaces = all\n---\n> #inet_interfaces = all\n116c116\n< #inet_interfaces = localhost\n---\n> inet_interfaces = localhost\n680,686d679\n< \n< disable_vrfy_command = yes\n< \n< smtpd_recipient_restrictions =\n<     reject_unauth_destination\n<     check_policy_service unix:private/policyd-spf\n< policyd-spf_time_limit = 3600\n")),(0,i.kt)("p",null,"Restart the postfix service after making changes to master.cf and main.cf."),(0,i.kt)("h2",{id:"examples"},"Examples"),(0,i.kt)("p",null,"Before sender added the SPF record to their DNS domain:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"[root@localhost ~]# telnet 192.168.99.25 25\nTrying 192.168.99.25...\nConnected to 192.168.99.25.\nEscape character is '^]'.\n220 mail.cp.net ESMTP Postfix\nHELO bigfoot.com\n250 mail.cp.net\nMAIL FROM: raymond@bigfoot.com\n250 2.1.0 Ok\nRCPT TO: root\n250 2.1.5 Ok\ndata\n354 End data with <CR><LF>.<CR><LF>\nHEllo,\nspf okay?\n.\n250 2.0.0 Ok: queued as DE38A10D8AEC\nquit\n221 2.0.0 Bye\nConnection closed by foreign host.\n")),(0,i.kt)("p",null,"After sender added the SPF record to their DNS domain and email from non-authorized host:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"[root@localhost ~]# telnet 192.168.99.25 25\nTrying 192.168.99.25...\nConnected to 192.168.99.25.\nEscape character is '^]'.\n220 mail.cp.net ESMTP Postfix\nhelo bigfoot.com.\n250 mail.cp.net\nmail from: ray@bigfoot.com \n250 2.1.0 Ok\nrcpt to: root\n550 5.7.1 <root>: Recipient address rejected: Message rejected due to: SPF fail - not authorized. Please see http://www.openspf.net/Why?s=mfrom;id=ray@bigfoot.com;ip=192.168.99.1;r=root\nquit\n221 2.0.0 Bye\nConnection closed by foreign host.\n")),(0,i.kt)("p",null,"Email from authorized host:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"[root@localhost ~]# telnet 192.168.99.25 25\nTrying 192.168.99.25...\nConnected to 192.168.99.25.\nEscape character is '^]'.\n220 mail.cp.net ESMTP Postfix\nhelo bigfoot.com.\n250 mail.cp.net\nmail from: ray@bigfoot.com\n250 2.1.0 Ok\nrcpt to: root\n250 2.1.5 Ok\ndata\n354 End data with <CR><LF>.<CR><LF>\nHello, this email should pass your mail server's spf filter.\nbye.\n.\n250 2.0.0 Ok: queued as 1CEE61055143\nquit\n221 2.0.0 Bye\nConnection closed by foreign host.\n")),(0,i.kt)("h2",{id:"messages-in-roots-mail-box"},"Messages In root's Mail Box"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"[root@mail ~]# cat /var/mail/root\nFrom raymond@bigfoot.com  Tue Nov 24 12:56:07 2015\nReturn-Path: <raymond@bigfoot.com>\nX-Original-To: root\nDelivered-To: root@mail.cp.net\nReceived-SPF: None (no SPF record) identity=mailfrom; client-ip=192.168.99.1; helo=bigfoot.com; envelope-from=raymond@bigfoot.com; receiver=root \nReceived: from bigfoot.com (unknown [192.168.99.1])\n    by mail.cp.net (Postfix) with SMTP id DE38A10D8AEC\n    for <root>; Tue, 24 Nov 2015 12:55:52 -0700 (MST)\n\nHEllo,\nspf okay?\n\nFrom ray@bigfoot.com  Tue Nov 24 16:07:33 2015\nReturn-Path: <ray@bigfoot.com>\nX-Original-To: root\nDelivered-To: root@mail.cp.net\nReceived-SPF: Pass (sender SPF authorized) identity=mailfrom; client-ip=192.168.99.1; helo=bigfoot.com.; envelope-from=ray@bigfoot.com; receiver=root \nReceived: from bigfoot.com. (mail.bigfoot.com [192.168.99.1])\n    by mail.cp.net (Postfix) with SMTP id 1CEE61055143\n    for <root>; Tue, 24 Nov 2015 16:07:06 -0700 (MST)\n\nHello, how your spf filter will pass this email.\nbye.\n")),(0,i.kt)("h2",{id:"maillog-postfix"},"MailLog (postfix)"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"[root@mail log]# ls -l maillog\n-rw-------. 1 root root 5896 Nov 24 16:16 maillog\n[root@mail log]# cat maillog\n\nNov 24 12:55:20 mail postfix/postfix-script[2283]: starting the Postfix mail system\nNov 24 12:55:20 mail postfix/master[2285]: daemon started -- version 2.10.1, configuration /etc/postfix\nNov 24 12:55:26 mail postfix/smtpd[2289]: connect from unknown[192.168.99.1]\nNov 24 12:55:57 mail policyd-spf[2293]: None; identity=helo; client-ip=192.168.99.1; helo=bigfoot.com; envelope-from=raymond@bigfoot.com; receiver=root\nNov 24 12:55:57 mail policyd-spf[2293]: None; identity=mailfrom; client-ip=192.168.99.1; helo=bigfoot.com; envelope-from=raymond@bigfoot.com; receiver=root\nNov 24 12:55:57 mail postfix/smtpd[2289]: DE38A10D8AEC: client=unknown[192.168.99.1]\nNov 24 12:56:07 mail postfix/cleanup[2294]: DE38A10D8AEC: message-id=<>\nNov 24 12:56:07 mail postfix/qmgr[2287]: DE38A10D8AEC: from=<raymond@bigfoot.com>, size=327, nrcpt=1 (queue active)\nNov 24 12:56:07 mail postfix/local[2295]: DE38A10D8AEC: to=<root@mail.cp.net>, orig_to=<root>, relay=local, delay=16, delays=16/0.04/0/0.02, dsn=2.0.0, status=sent (delivered to mailbox)\nNov 24 12:56:07 mail postfix/qmgr[2287]: DE38A10D8AEC: removed\nNov 24 12:56:14 mail postfix/smtpd[2289]: disconnect from unknown[192.168.99.1]\nNov 24 16:04:34 mail postfix/smtpd[2843]: connect from mail.bigfoot.com[192.168.99.1]\nNov 24 16:04:58 mail policyd-spf[2847]: None; identity=helo; client-ip=192.168.99.1; helo=bigfoot.com.; envelope-from=ray@bigfoot.com; receiver=root\nNov 24 16:04:58 mail policyd-spf[2847]: Fail; identity=mailfrom; client-ip=192.168.99.1; helo=bigfoot.com.; envelope-from=ray@bigfoot.com; receiver=root\nNov 24 16:04:58 mail postfix/smtpd[2843]: NOQUEUE: reject: RCPT from mail.bigfoot.com[192.168.99.1]: 550 5.7.1 <root>: Recipient address rejected: Message rejected due to: SPF fail - not authorized. Please see http://www.openspf.net/Why?s=mfrom;id=ray@bigfoot.com;ip=192.168.99.1;r=root; from=<ray@bigfoot.com> to=<root> proto=SMTP helo=<bigfoot.com.>\nNov 24 16:06:47 mail postfix/smtpd[2843]: disconnect from mail.bigfoot.com[192.168.99.1]\nNov 24 16:06:48 mail postfix/smtpd[2843]: connect from mail.bigfoot.com[192.168.99.1]\nNov 24 16:07:11 mail policyd-spf[2847]: None; identity=helo; client-ip=192.168.99.1; helo=bigfoot.com.; envelope-from=ray@bigfoot.com; receiver=root\nNov 24 16:07:11 mail policyd-spf[2847]: Pass; identity=mailfrom; client-ip=192.168.99.1; helo=bigfoot.com.; envelope-from=ray@bigfoot.com; receiver=root\nNov 24 16:07:11 mail postfix/smtpd[2843]: 1CEE61055143: client=mail.bigfoot.com[192.168.99.1]\nNov 24 16:07:33 mail postfix/cleanup[2849]: 1CEE61055143: message-id=<>\nNov 24 16:07:33 mail postfix/qmgr[2287]: 1CEE61055143: from=<ray@bigfoot.com>, size=379, nrcpt=1 (queue active)\nNov 24 16:07:33 mail postfix/local[2850]: 1CEE61055143: to=<root@mail.cp.net>, orig_to=<root>, relay=local, delay=27, delays=27/0.03/0/0.02, dsn=2.0.0, status=sent (delivered to mailbox)\nNov 24 16:07:33 mail postfix/qmgr[2287]: 1CEE61055143: removed\nNov 24 16:07:36 mail postfix/smtpd[2843]: disconnect from mail.bigfoot.com[192.168.99.1]\nNov 24 16:14:54 mail postfix/smtpd[2853]: connect from pri[192.168.99.53]\nNov 24 16:15:21 mail policyd-spf[2857]: None; identity=helo; client-ip=192.168.99.53; helo=bigfoot.com.; envelope-from=tommy@bigfoot.com; receiver=root\nNov 24 16:15:21 mail policyd-spf[2857]: Fail; identity=mailfrom; client-ip=192.168.99.53; helo=bigfoot.com.; envelope-from=tommy@bigfoot.com; receiver=root\nNov 24 16:15:21 mail postfix/smtpd[2853]: NOQUEUE: reject: RCPT from pri[192.168.99.53]: 550 5.7.1 <root>: Recipient address rejected: Message rejected due to: SPF fail - not authorized. Please see http://www.openspf.net/Why?s=mfrom;id=tommy@bigfoot.com;ip=192.168.99.53;r=root; from=<tommy@bigfoot.com> to=<root> proto=SMTP helo=<bigfoot.com.>\nNov 24 16:16:03 mail postfix/smtpd[2853]: NOQUEUE: reject: RCPT from pri[192.168.99.53]: 550 5.7.1 <spr500>: Recipient address rejected: Received-SPF: Fail (SPF fail - not authorized) identity=mailfrom; client-ip=192.168.99.53; helo=bigfoot.com.; envelope-from=tommy@bigfoot.com; receiver=root ; from=<tommy@bigfoot.com> to=<spr500> proto=SMTP helo=<bigfoot.com.>\nNov 24 16:16:06 mail postfix/smtpd[2853]: disconnect from pri[192.168.99.53]\n")))}p.isMDXComponent=!0}}]);