"use strict";(self.webpackChunkOPS535=self.webpackChunkOPS535||[]).push([[813],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return p}});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=n.createContext({}),m=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},c=function(e){var t=m(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=m(a),p=i,h=d["".concat(s,".").concat(p)]||d[p]||u[p]||o;return a?n.createElement(h,r(r({ref:t},c),{},{components:a})):n.createElement(h,r({ref:t},c))}));function p(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=a.length,r=new Array(o);r[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var m=2;m<o;m++)r[m]=a[m];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},8587:function(e,t,a){a.r(t),a.d(t,{assets:function(){return s},contentTitle:function(){return r},default:function(){return u},frontMatter:function(){return o},metadata:function(){return l},toc:function(){return m}});var n=a(3117),i=(a(7294),a(3905));const o={id:"lab7",title:"Lab 7",sidebar_position:12,description:"Lab 7"},r="Lab 7",l={unversionedId:"A-Labs/lab7",id:"A-Labs/lab7",title:"Lab 7",description:"Lab 7",source:"@site/docs/A-Labs/lab7.md",sourceDirName:"A-Labs",slug:"/A-Labs/lab7",permalink:"/OPS535/A-Labs/lab7",draft:!1,editUrl:"https://github.com/Seneca-ICTOER/OERTemplate/tree/main/docs/A-Labs/lab7.md",tags:[],version:"current",sidebarPosition:12,frontMatter:{id:"lab7",title:"Lab 7",sidebar_position:12,description:"Lab 7"},sidebar:"courseNotesSidebar",previous:{title:"Lab 6",permalink:"/OPS535/A-Labs/lab6"},next:{title:"Lab 8",permalink:"/OPS535/A-Labs/lab8"}},s={},m=[{value:"Objectives",id:"objectives",level:2},{value:"Pre-Requisites",id:"pre-requisites",level:2},{value:"Investigation 1: Configuring Postfix to use Restrictions",id:"investigation-1-configuring-postfix-to-use-restrictions",level:2},{value:"Investigation 2: Configuring Postfix to Check SPF Records",id:"investigation-2-configuring-postfix-to-check-spf-records",level:2},{value:"Investigation 3: Configuring DNS to Provide SPF Records",id:"investigation-3-configuring-dns-to-provide-spf-records",level:2},{value:"Completing the Lab",id:"completing-the-lab",level:2}],c={toc:m};function u(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"lab-7"},"Lab 7"),(0,i.kt)("h2",{id:"objectives"},"Objectives"),(0,i.kt)("p",null,"In this lab you will learn to"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"configure postfix (an SMTP server) to use extra security to filter unwanted and suspicious email,"),(0,i.kt)("li",{parentName:"ul"},"configure DNS servers to provide extra records to allow mail servers to authenticate incoming mail.")),(0,i.kt)("h2",{id:"pre-requisites"},"Pre-Requisites"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Complete Lab 5 (SMTP Lab), and Lab 6 (Routing Lab)."),(0,i.kt)("li",{parentName:"ul"},"A working primary DNS server for your domain,"),(0,i.kt)("li",{parentName:"ul"},"A basic knowledge of the SMTP protocol (covered in lab 5.")),(0,i.kt)("h2",{id:"investigation-1-configuring-postfix-to-use-restrictions"},"Investigation 1: Configuring Postfix to use Restrictions"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Referenec")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://wiki.centos.org/HowTos/postfix_restrictions"},"Postfix Restrictions"))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Perform the following steps as a regular user on your VM1")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Using the nc command and the smtp commands you already learned, connect to VM2 and send an email to your root user. Make sure to use the address and hostnames of your own VMs.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"> nc 192.168.6.2 25\n220 pri-dns.rchan.ops ESMTP Postfix\nhelo router.rchan.ops\n250 pri-dns.rchan.ops\nmail from: root@router.rchan.ops\n250 2.1.0 Ok\nrcpt to:root@pri-dns.rchan.ops\n250 2.1.5 Ok\ndata\n354 End data with <CR><LF>.<CR><LF>\ntest\n.\n250 2.0.0 Ok: queued as 728CB82ECF6\nquit\n221 2.0.0 Bye\n")),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},"Send another email, but this time skip the HELO command.")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Notice that the email is accepted anyway.")),(0,i.kt)("ol",{start:3},(0,i.kt)("li",{parentName:"ol"},"Edit the /etc/posftfix/main.cf file on VM2 and add the following line (restarting once you have done so):")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"smtpd_helo_required = yes\n")),(0,i.kt)("ol",{start:4},(0,i.kt)("li",{parentName:"ol"},"Try sending an email without the HELO command again.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Notice that it is immediately rejected."),(0,i.kt)("li",{parentName:"ul"},"This simple step will filter out a surprising amount of spam, as many spam email servers skip the helo step in order to save time when sending massive amounts of email."))),(0,i.kt)("li",{parentName:"ol"},"Send another email using nc, this time include the helo command, but just put junk in it.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"smtpd_helo_required doesn\u2019t do anything to check the data in the helo command, it just requires that the connecting server says helo."))),(0,i.kt)("li",{parentName:"ol"},"Edit the /etc/posftfix/main.cf file on VM2 and add the following line (restarting once you have done so):")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"smtpd_helo_restrictions = reject_non_fqdn_helo_hostname, permit\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Send another email, again using junk in the helo command."),(0,i.kt)("li",{parentName:"ul"},"Notice that the email does get rejected on the basis of the non-fully-qualified hostname, but that it does not happen until you try to use the rcpt to command."),(0,i.kt)("li",{parentName:"ul"},"By default, most rejections will behave this way, gathering as much information as possible about the potentially malicious machine, but preventing it from actually sending the mail.By default, most rejections will behave this way, gathering as much information as possible about the potentially malicious machine, but preventing it from actually sending the mail.")),(0,i.kt)("ol",{start:7},(0,i.kt)("li",{parentName:"ol"},"We will force rejections to happen immediately, so that you can see the effects of each parameter as we add them.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Edit the /etc/posftfix/main.cf file on VM2 and add the following line:")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"smtpd_delay_reject = no\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"I am going to stop reminding you to restart the service after changing every parameter, just assume that you should do so anytime you make a change to the configuration file.")),(0,i.kt)("ol",{start:8},(0,i.kt)("li",{parentName:"ol"},"Try to send your email again.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"This time you should see the rejection message as soon as you try to use the malformed helo command.\nThere are other restrictions you can use to filter mail based on the contents of the helo command, but I will let you explore those yourself."))),(0,i.kt)("li",{parentName:"ol"},"You can also filter mail based on the client machine attempting to connect to you. For example, if it doesn\u2019t have an A or PTR records in DNS, then it almost certainly is not a legitimate email server.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Edit the /etc/posftfix/main.cf file on VM2 and add the following line:")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"smtpd_client_restrictions = reject_unknown_client_hostname, permit\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Checking the effects of this might be more complicated, as you will need a machine that doesn\u2019t exist in DNS.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Change your VM1's 192.168.x.0/24 IP address to a different value, for example, 192.168.x.53. but in the same network."),(0,i.kt)("li",{parentName:"ul"},"Try to connect with nc again. You should get rejected immediately."))),(0,i.kt)("li",{parentName:"ul"},"Edit the smtpd_client_restrictions line you just added to /etc/posftfix/main.cf file on VM2:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"smtpd_client_restrictions = permit_mynetworks, reject_unknown_client_hostname, permit\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Try to connect with nc again. This time you are allowed to connect. Because you are in a network defined in the servers mynetworks parameter (that is, your other machine is \u2018trusted\u2019), you pass this check and are not subject to the reject_unknown_client_hostname restriction.")),(0,i.kt)("ol",{start:10},(0,i.kt)("li",{parentName:"ol"},"You can also filter mail based on the sender\u2019s address. For example, if it isn\u2019t a properly formatted email address, it is probably spam.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"edit the /etc/posftfix/main.cf file on VM2 and add the following line:")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"smtpd_sender_restrictions = permit_mynetworks, reject_non_fqdn_sender, reject_unknown_sender_domain, permit\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"These will reject email if the sender\u2019s address provided in the mail from command is not a fully qualified email address, or if the sending email address does not have an MX record that matches it (this is why your emails to Seneca\u2019s servers in OPS335 often failed)."),(0,i.kt)("li",{parentName:"ul"},"Notice the inclusion of two settings we also used in previous restrictions, particularly permit_mynetworks, exempting your own machines from these checks."),(0,i.kt)("li",{parentName:"ul"},"Back on VM1, us the nc command to try to send emails that will pass and fail this restriction.")),(0,i.kt)("ol",{start:11},(0,i.kt)("li",{parentName:"ol"},"You can filter mail based on the recipient\u2019s address as well. For example, if it isn\u2019t a properly formatted email address, it is possibly spam.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Edit the /etc/posftfix/main.cf file on VM2 and add the following line:")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"smtpd_recipient_restrictions = permit_mynetworks, reject_non_fqdn_recipient, reject_unauth_destination, permit\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"These will reject email if the recipient address provided in the rcpt to command is not a fully qualified email address, or if email address it is being sent to would not match your mydestination parameter."),(0,i.kt)("li",{parentName:"ul"},"Notice the inclusion of two settings we also used in previous restrictions, particularly permit_mynetworks, exempting your own machines from these checks."),(0,i.kt)("li",{parentName:"ul"},"Back on VM1, us the nc command to try to send emails that will pass and fail this restriction.")),(0,i.kt)("ol",{start:12},(0,i.kt)("li",{parentName:"ol"},"There are even restrictions you can place on email that you are relaying to another server. These are governed by the smtpd_relay_restrictions parameter.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Edit the /etc/posftfix/main.cf file on VM2 and add the following line:")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"smtpd_relay_restrictions = reject_unauth_destination, reject_unknown_recipient_domain, permit\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"These restrictions will reject that the sending MTA tried to relay through your server if the destination is not in relay_domains, or if the domain has no MX record."),(0,i.kt)("li",{parentName:"ul"},"Note that the reject_unauth_destination setting can show up here and in recipient restrictions. It is the same parameter, but has a different effect.")),(0,i.kt)("ol",{start:13},(0,i.kt)("li",{parentName:"ol"},"There are more restrictions that you can place on incoming email, but the checks you have added in this investigation will eliminate the vast majority of spam. Anything that is not following the RFCs properly (e.g. skipping the helo command) will be blocked. One thing you will notice about the checks related to DNS records is that they are only checking that the records are there, not that they are correct, or that the server sending us mail actually is the machine it is claiming to be.")),(0,i.kt)("h2",{id:"investigation-2-configuring-postfix-to-check-spf-records"},"Investigation 2: Configuring Postfix to Check SPF Records"),(0,i.kt)("p",null,"Perform the following steps as root on your VM2"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Now that you know your email server is restricting incoming (and relayed) mail based on some simple checks, we can add in some information from DNS to improve these checks. For example, we can lookup the DNS records for the domain that seems to be sending us email and check if the ip address of the machine sending us mail matches on of the MX records."),(0,i.kt)("li",{parentName:"ol"},"To see what is not being caught by the restrictions so far, use nc to send an email to your server claiming to be from ",(0,i.kt)("a",{parentName:"li",href:"mailto:root@rchan.ops"},"root@rchan.ops"),".",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"The email goes through because that domain has a properly configured MX record, even though your ip address doesn\u2019t match it."),(0,i.kt)("li",{parentName:"ul"},"Sender Policy Framework (SPF) will fix that."))),(0,i.kt)("li",{parentName:"ol"},"First we will add the sender policy framework to our mail server:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Install the pypolicyd-spf package"),(0,i.kt)("li",{parentName:"ul"},"Add spf as a spawnable process. To do so, add the following line to /etc/postfix/master.cf:")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"policyd-spf unix \u2013 n n \u2013 0 spawn user=nobody argv=/usr/libexec/postfix/policyd-spf\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Finally, add an spf check to the recipient restrictions in /etc/postfix/main.cf:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"check_policy_service unix:private/policyd-spf\n")),(0,i.kt)("ol",{start:4},(0,i.kt)("li",{parentName:"ol"},"Now try to send another email to your server, again claiming to be from ",(0,i.kt)("a",{parentName:"li",href:"mailto:root@rchan.ops"},"root@rchan.ops"),".",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"This time it will get blocked, because your server looks up the DNS record and finds out that you are not actually the mail server for that domain.")))),(0,i.kt)("h2",{id:"investigation-3-configuring-dns-to-provide-spf-records"},"Investigation 3: Configuring DNS to Provide SPF Records"),(0,i.kt)("p",null,"Perform the following steps as root on your VM2(also your primary DNS server)"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"SPF depends on the DNS server providing information about which machines are supposed to be sending mail for that domain."),(0,i.kt)("li",{parentName:"ol"},"Each spf record (a specially formatted TXT record) identifies which machines can send mail for the domain, and the machines in that domain, and which machines can not."),(0,i.kt)("li",{parentName:"ol"},"Add the following record to your DNS zone:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},'@ IN TXT "v=spf1 mx -all"\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"This specifies that for your domain (@), machines with MX records are allowed to send email, but no other machines should (-all).")),(0,i.kt)("ol",{start:4},(0,i.kt)("li",{parentName:"ol"},"Now try to send email to your server, claiming to be host.<yourdomain",">",".ops sending mail from root@<yourdomain",">",".ops",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"It should now fail, because SPF sees that it doesn\u2019t match."))),(0,i.kt)("li",{parentName:"ol"},"Try to send that email again, this time claiming to be from root@host.<yourdomain",">",".ops",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"This gets through the check because the record you added in step three is only for the domain, not the individual machines in it."),(0,i.kt)("li",{parentName:"ul"},"To properly secure mail, you need an spf record for every machine too."),(0,i.kt)("li",{parentName:"ul"},"So add an spf record like the one above for every machine in your domain, replacing the @ with the hostname.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"If you remember how to use white-space at the beginning of records, you can save yourself some typing."))),(0,i.kt)("li",{parentName:"ul"},"Now try to send the email claiming to be root@host.<yourdomain",">",".ops again. This time it should fail."))),(0,i.kt)("li",{parentName:"ol"},"There is one more SPF record needed to stop someone from spoofing our mail. We need a record for the machines that don\u2019t exist, otherwise someone can just claim to be sending mail from a machine name you don\u2019t have, or a sub-domain.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"First, send yet another email, this time claiming to be from ",(0,i.kt)("a",{parentName:"li",href:"mailto:root@.void"},"root@.void"),"<yourdomain",">",".ops (or some other machine that doesn\u2019t exist)."),(0,i.kt)("li",{parentName:"ul"},"Now add the following record to your zone:")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'*.<yourdomain>.ops. IN TXT "v=spf1 mx:<yourdomain>.ops -all"\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"This acts as a wildcard and says that any machine in your domain that doesn\u2019t have a record, and any sub-domain that doesn\u2019t have a record should only be sending email from one of your mail servers with the MX records."),(0,i.kt)("li",{parentName:"ul"},"Try sending your spoofed email again. It should no longer work.")),(0,i.kt)("h2",{id:"completing-the-lab"},"Completing the Lab"),(0,i.kt)("p",null,"Your DNS and email servers are now cooperating to filter email and prevent malicious email from being sent to your users. They are also providing information making it difficult for others to impersonate your domain. There are more restrictions that can be used, and situations where your spf records would look different, but this is a good basis for any domain."),(0,i.kt)("p",null,"Follow the instructions on blackboard to submit the lab."))}u.isMDXComponent=!0}}]);