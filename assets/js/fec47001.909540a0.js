"use strict";(self.webpackChunkOPS535=self.webpackChunkOPS535||[]).push([[1367],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return m}});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var i=n.createContext({}),p=function(e){var t=n.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(i.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,i=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(a),m=o,h=u["".concat(i,".").concat(m)]||u[m]||d[m]||r;return a?n.createElement(h,s(s({ref:t},c),{},{components:a})):n.createElement(h,s({ref:t},c))}));function m(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,s=new Array(r);s[0]=u;var l={};for(var i in t)hasOwnProperty.call(t,i)&&(l[i]=t[i]);l.originalType=e,l.mdxType="string"==typeof e?e:o,s[1]=l;for(var p=2;p<r;p++)s[p]=a[p];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},159:function(e,t,a){a.r(t),a.d(t,{assets:function(){return i},contentTitle:function(){return s},default:function(){return d},frontMatter:function(){return r},metadata:function(){return l},toc:function(){return p}});var n=a(3117),o=(a(7294),a(3905));const r={id:"lab3-stage1",title:"Lab 3 Part 1",sidebar_position:6,description:"Lab 3 Stage 1"},s="Lab 3 - Stage 1",l={unversionedId:"A-Labs/lab3-stage1",id:"A-Labs/lab3-stage1",title:"Lab 3 Part 1",description:"Lab 3 Stage 1",source:"@site/docs/A-Labs/lab3-stage1.md",sourceDirName:"A-Labs",slug:"/A-Labs/lab3-stage1",permalink:"/OPS535/A-Labs/lab3-stage1",draft:!1,editUrl:"https://github.com/Seneca-ICTOER/OERTemplate/tree/main/docs/A-Labs/lab3-stage1.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{id:"lab3-stage1",title:"Lab 3 Part 1",sidebar_position:6,description:"Lab 3 Stage 1"},sidebar:"courseNotesSidebar",previous:{title:"Lab 2 Part 2",permalink:"/OPS535/A-Labs/lab2-stage2"},next:{title:"Lab 3 Part 2",permalink:"/OPS535/A-Labs/lab3-stage2"}},i={},p=[{value:"Purpose",id:"purpose",level:2},{value:"Pre-Requisites",id:"pre-requisites",level:2},{value:"References",id:"references",level:2},{value:"Investigation 1: OpenLDAP Server Setup and Configuration",id:"investigation-1-openldap-server-setup-and-configuration",level:2},{value:"Investigation 2: Modifying OpenLDAP Server Configuration to use TLS",id:"investigation-2-modifying-openldap-server-configuration-to-use-tls",level:2},{value:"Investigation 3: Setup and Configure OpenLdap Client Through SSSD",id:"investigation-3-setup-and-configure-openldap-client-through-sssd",level:2},{value:"Investigation 4: Update LDAP Configuration",id:"investigation-4-update-ldap-configuration",level:2},{value:"Completing the Lab",id:"completing-the-lab",level:2},{value:"Exploration Questions",id:"exploration-questions",level:2}],c={toc:p};function d(e){let{components:t,...a}=e;return(0,o.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"lab-3---stage-1"},"Lab 3 - Stage 1"),(0,o.kt)("h2",{id:"purpose"},"Purpose"),(0,o.kt)("p",null,"The OpenLDAP software package is a Free and Open Source implementation of the Lightweight Directory Access Protocol (LDAP). It is gaining wide acceptance as the directory access method of the Internet and also with corporate intranets. In this lab, you set up and configure an OpenLDAP server to provide directory service for LDAP Clients to authenticate network users. You can use OpenLDAP server to replace NIS to centrally store network user account information for OpenLDAP client to authenticate network users. The basic components of an LDAP server are its Object Classes and Attribute types defined in one or more Schema. To provide the necessary attribute types (ie. Field) for storing Linux (or Unix, aka Posix) user accounts, you need to include the \u201ccosine\u201d, \u201cnis\u201d, and \u201cinetorgperson\u201d schemata in addition to the \u201ccore\u201d schema. Notes: OpenLDAP Use TCP port 389 for regular network communication between clients and servers, and use port 636 for encrypted network communication between clients and servers. If you have firewalls between your LDAP server and LDAP clients, you need to open the above TCP ports on the firewall to allow LDAP traffic to get through."),(0,o.kt)("p",null,"Designate vm1 as your LDAP server and use vm2 and vm3 as LDAP clients"),(0,o.kt)("h2",{id:"pre-requisites"},"Pre-Requisites"),(0,o.kt)("p",null,"The pre-lab must be complete so that your virtual machines share access to a private network. Lab 1 must be complete so each machine has a well configured firewall. Make sure each machine is fully updated."),(0,o.kt)("h2",{id:"references"},"References"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_authentication_and_authorization_in_rhel/configuring-sssd-to-use-ldap-and-require-tls-authentication_configuring-authentication-and-authorization-in-rhel"},"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_authentication_and_authorization_in_rhel/configuring-sssd-to-use-ldap-and-require-tls-authentication_configuring-authentication-and-authorization-in-rhel")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.golinuxcloud.com/configure-openldap-with-tls-certificates/"},"https://www.golinuxcloud.com/configure-openldap-with-tls-certificates/")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.golinuxcloud.com/ldap-client-rhel-centos-8"},"https://www.golinuxcloud.com/ldap-client-rhel-centos-8")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://kifarunix.com/configure-sssd-for-openldap-authentication-on-centos-8/"},"https://kifarunix.com/configure-sssd-for-openldap-authentication-on-centos-8/")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.mankier.com/package/authselect"},"authselect package")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"http://httpd.apache.org/docs/2.4/ssl/ssl_faq.html"},"Create server key and certificate tutorial (Apache Doc)"))),(0,o.kt)("h2",{id:"investigation-1-openldap-server-setup-and-configuration"},"Investigation 1: OpenLDAP Server Setup and Configuration"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Warning: Make a backup before you start this lab. It is very difficult to recover this service if you make a mistake in configuration.")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Perform the following steps on vm1")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Install yum-utils")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Install the symas ldap repo (who now maintain a version of it available for Centos 8:"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"yum-config-manager --add-repo=",(0,o.kt)("a",{parentName:"li",href:"https://repo.symas.com/configs/SOFL/rhel8/sofl.repo"},"https://repo.symas.com/configs/SOFL/rhel8/sofl.repo")))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Install the following packages"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"openldap"),(0,o.kt)("li",{parentName:"ul"},"symas-openldap-clients"),(0,o.kt)("li",{parentName:"ul"},"symas-openldap-servers"),(0,o.kt)("li",{parentName:"ul"},"perl"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"In older releases a package called 'migrationtools' was available that contained a number of perl scripts used to convert information from other sources (e.g. /etc/passwd) into ldif files. Since it is no longer part of standard repos in Centos 8, download the copy I have provided on blackboard and extract it to /usr/share/migrationtools.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Check the content of the file directory ",(0,o.kt)("strong",{parentName:"p"},"/etc/openldap/slapd.d/cn=config/")," for the top branch of OpenLDAP directory configuration files:"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cn=schema\ncn=schema.ldif\nolcDatabase={0}config.ldif\nolcDatabase={1}monitor.ldif\nolcDatabase={-1}frontend.ldif\nolcDatabase={2}mdb.ldif\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Examine the contents of olcDatabase={2}mbd.ldif:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# AUTO-GENERATED FILE - DO NOT EDIT!! Use ldapmodify.\n# CRC32 d9b49d55\ndn: olcDatabase={2}hdb\nobjectClass: olcDatabaseConfig\nobjectClass: olcMdbConfig\nolcDatabase: {2}mdb\nolcDbDirectory: /var/lib/ldap\nolcSuffix: dc=my-domain,dc=com\nolcRootDN: cn=Manager,dc=my-domain,dc=com\nolcDbIndex: objectClass eq,pres\nolcDbIndex: ou,cn,mail,surname,givenname eq,pres,sub\nstructuralObjectClass: olcMdbConfig\nentryUUID: 5a8d299a-3f2f-1036-9244-a7abff537081\ncreatorsName: cn=config\ncreateTimestamp: 20161115032843Z\nentryCSN: 20161115032843.258885Z#000000#000#000000\nmodifiersName: cn=config\nmodifyTimestamp: 20161115032843Z\n")),(0,o.kt)("ol",{start:6},(0,o.kt)("li",{parentName:"ol"},"Verify that the directory for storing the OpenLDAP database (",(0,o.kt)("strong",{parentName:"li"},"/var/lib/ldap"),") is owned by ldap:ldap. If this is not the case, fix it now."),(0,o.kt)("li",{parentName:"ol"},"Verify that the core schema file (",(0,o.kt)("strong",{parentName:"li"},"/etc/openldap/slapd.d/cn=config/cn=schema"),") is also owned by ldap:ldap."),(0,o.kt)("li",{parentName:"ol"},"Start the ldap service (",(0,o.kt)("strong",{parentName:"li"},"slapd"),"), and ensure that it will automatically start when your machine boots. Check the status of the service and ensure that it started without error before continuing."),(0,o.kt)("li",{parentName:"ol"},"Use the ldap add command to add the cosine, nis, and inetorgperson schemata to your server ",(0,o.kt)("strong",{parentName:"li"},"in that order"),". Use the authentication type ",(0,o.kt)("strong",{parentName:"li"},"EXTERNAL"),", and ",(0,o.kt)("strong",{parentName:"li"},"ldapi:///")," as the host."),(0,o.kt)("li",{parentName:"ol"},"List the schema directory again. This time you should see the core schema, along with the three schemata you just added."),(0,o.kt)("li",{parentName:"ol"},"Run an ldapsearch to check that the service is running and will respond to queries:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"[root@rns ~]# ldapsearch -x -b '' -s base '(objectClass=*)' namingContexts\n# extended LDIF\n#\n# LDAPv3\n# base <> with scope baseObject\n# filter: (objectClass=*)\n# requesting: namingContexts\n#\n#\ndn:\nnamingContexts: dc=my-domain,dc=com\n# search result\nsearch: 2\nresult: 0 Success\n# numResponses: 2\n# numEntries: 1\n")),(0,o.kt)("ol",{start:12},(0,o.kt)("li",{parentName:"ol"},"Next, you will need a password for the ldap administrator (RootDN), so that they can run commands to modify the database. Use the slappasswd command to create one, and record the output."),(0,o.kt)("li",{parentName:"ol"},"Insert your new password into the following ldif file, and apply it to your database with the ldapmodify command")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Warning: Do not store your ldif files (or any other files) in the ldap configuration directory. Every file in that directory is automatically read as configuration for ldap.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# customize domain name\ndn: olcDatabase={2}mdb,cn=config\nchangetype: modify\nreplace: olcSuffix\nolcSuffix: dc=ops535,dc=com\n\ndn: olcDatabase={2}mdb,cn=config\nchangetype: modify\nreplace: olcRootDN\nolcRootDN: cn=Manager,dc=ops535,dc=com\n\ndn: olcDatabase={2}mdb,cn=config\nchangetype: modify\nadd: olcRootPW\nolcRootPW: {SSHA}1Di4Suea6ojE2bFxJhLDScjQyQ97GSef\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Make note of the field that this file will modify."),(0,o.kt)("li",{parentName:"ul"},"As before, use the authentication type ",(0,o.kt)("strong",{parentName:"li"},"EXTERNAL"),", and ",(0,o.kt)("strong",{parentName:"li"},"ldapi:///")," as the host."),(0,o.kt)("li",{parentName:"ul"},"When you run the command you should get output similar to the following:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'SASL/EXTERNAL authentication started\nSASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth\nSASL SSF: 0\nmodifying entry "olcDatabase={2}mdb,cn=config"\n\nmodifying entry "olcDatabase={2}mdb,cn=config"\n\nmodifying entry "olcDatabase={2}mdb,cn=config"\n')),(0,o.kt)("ol",{start:14},(0,o.kt)("li",{parentName:"ol"},"Examine the contents of your ",(0,o.kt)("strong",{parentName:"li"},"/etc/openldap/slapd.d/cn=config/olcDatabase={2}mdb.ldif")," file again. Your ldif file should have changed three fields. Try to identify them."),(0,o.kt)("li",{parentName:"ol"},"Create an LDIF file for the base context ops535.com entry to be added to the OpenLDAP directory. Name the file as base.ldif.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"dn: dc=ops535,dc=com\ndc: ops535\ndescription: root LDAP entry for ops535\nobjectClass: dcObject\nobjectClass: organizationalUnit\nou: rootobject\n")),(0,o.kt)("ol",{start:16},(0,o.kt)("li",{parentName:"ol"},"Create an LDIF file for the People container to be added to the OpenLDAP directory. Name the file as people.ldif")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"dn: ou=People, dc=ops535, dc=com\nou: People\ndescription: All people in ops535\nobjectClass: organizationalUnit\n")),(0,o.kt)("ol",{start:17},(0,o.kt)("li",{parentName:"ol"},"Apply those two ldif files to your database. This time you will need to use simple authentication, identify yourself with a distinguished name (use the ldap administrator whose password you just set), and get prompted for a password."),(0,o.kt)("li",{parentName:"ol"},"Before we start adding users, we need to provide the migration tools some information about our domain. Before you change anything, make a backup of the /usr/share/migrationstools/migrate_common.ph to the /root directory. Modify the following parameters in the original file to the values shown below:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'$DEFAULT_MAIL_DOMAIN = "ops535.com";\n$DEFAULT_BASE = "dc=ops535,dc=com";\n$EXTENDED_SCHEMA = 1;\n')),(0,o.kt)("ol",{start:19},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create two new users (",(0,o.kt)("strong",{parentName:"p"},"ldapuser1")," and ",(0,o.kt)("strong",{parentName:"p"},"ldapuser2"),") on your machine, and set their passwords. Importing those users into your ldap database will take several steps:"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},'Extract the passwd entries of ldapuser1 and ldapuser2 from /etc/passwd to a file called "ldapusers.entry"')))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"grep -w ldapuser1 /etc/passwd > /root/ldapusers.entry\ngrep -w ldapuser2 /etc/passwd >> /root/ldapusers.entry\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Use the migrate_passwd.pl file to convert the user information you extracted earlier into an ldif file:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"/usr/share/migrationtools/migrate_passwd.pl ldapusers.entry /root/ldapusers.ldif\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"This should generate an ldif file similar to the following:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"dn: uid=ldapuser1,ou=People,dc=ops535,dc=com\nuid: ldapuser1\ncn: ldapuser1\nsn: ldapuser1\nmail: ldapuser1@ops535.com\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: top\nobjectClass: shadowAccount\nuserPassword: {crypt}\n$6$PBqQXRo/ugCCjBe0.ZgvmJl8U2tVjpdR8X9bh4OZ1cl3mv4xf0Hv1HSDavkxusO8R3lI\nuuJ7skrfqpTQpbZ6hbd3e3BGB.\nshadowLastChange: 17120\nshadowMin: 0\nshadowMax: 99999\nshadowWarning: 7\nloginShell: /bin/bash\nuidNumber: 5001\ngidNumber: 5001\nhomeDirectory: /home/ldapuser1\n\ndn: uid=ldapuser2,ou=People,dc=ops535,dc=com\nuid: ldapuser2\ncn: ldapuser2\nsn: ldapuser2\nmail: ldapuser2@ops535.com\nobjectClass: person\nobjectClass: organizationalPersonobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: top\nobjectClass: shadowAccount\nuserPassword: {crypt}\n$6$VNkVk1TQ$Rgz4GnQlqPBcHhIinUqxFGnqHZmnHHrFyCQ1ZsekoRjHnaKvb84YtjfFRPL\n/xcbryrQRL5eNZeP01A3AdC2lv1\nshadowLastChange: 17120\nshadowMin: 0\nshadowMax: 99999\nshadowWarning: 7\nloginShell: /bin/bash\nuidNumber: 5002\ngidNumber: 5002\nhomeDirectory: /home/ldapuser2\n")),(0,o.kt)("ol",{start:20},(0,o.kt)("li",{parentName:"ol"},"Use ldapadd to enter this new information into the database. As before use simple authentication, the distinguished name of the ldap administrator, and get prompted for a password."),(0,o.kt)("li",{parentName:"ol"},"Use ldapsearch to confirm that the new users have been added to the database. You should get output similar to the following:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# extended LDIF\n#\n# LDAPv3\n# base <dc=ops535,dc=com> with scope subtree\n# filter: (objectClass=*)\n# requesting: ALL\n#\n\n# ops535.com\ndn: dc=ops535,dc=com\nobjectClass: top\nobjectClass: dcObject\nobjectClass: organization\no: ops535 com\ndc: ops535\n\n# Manager, ops535.com\ndn: cn=Manager,dc=ops535,dc=com\nobjectClass: organizationalRole\ncn: Manager\ndescription: Directory Manager\n\n# People, ops535.com\ndn: ou=People,dc=ops535,dc=com\nobjectClass: organizationalUnit\nou: People\n\n# ldapuser1, People, ops535.com\ndn: uid=ldapuser1,ou=People,dc=ops535,dc=com\nuid: ldapuser1\ncn: ldapuser1\nsn: ldapuser1\nmail: ldapuser1@ops535.com\nobjectClass: personobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: top\nobjectClass: shadowAccount\nuserPassword:: e2NyeXB0fSQ2JFBCcVFYUm8vJHVnQ0NqQmUwLlpndm1KbDhVMnRWanBkUjhYOWJ\noNE9aMWNsM212NHhmMEh2MUhTRGF2a3h1c084UjNsSXV1Sjdza3JmcXBUUXBiWjZoYmQzZTNCR0Iu\nshadowLastChange: 17120\nshadowMin: 0\nshadowMax: 99999\nshadowWarning: 7\nloginShell: /bin/bash\nuidNumber: 5001\ngidNumber: 5001\nhomeDirectory: /home/ldapuser1\n\n# ldapuser2, People, ops535.com\ndn: uid=ldapuser2,ou=People,dc=ops535,dc=com\nuid: ldapuser2\ncn: ldapuser2\nsn: ldapuser2\nmail: ldapuser2@ops535.com\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: top\nobjectClass: shadowAccount\nuserPassword:: e2NyeXB0fSQ2JFZOa1ZrMVRRJFJnejRHblFscVBCY0hoSWluVXF4RkducUhabW5\nISHJGeUNRMVpzZWtvUmpIbmFLdmI4NFl0amZGUlBML3hjYnJ5clFSTDVlTlplUDAxQTNBZEMybHYx\nshadowLastChange: 17120\nshadowMin: 0\nshadowMax: 99999\nshadowWarning: 7\nloginShell: /bin/bash\nuidNumber: 5002\ngidNumber: 5002\nhomeDirectory: /home/ldapuser2\n\n# search result\nsearch: 2\nresult: 0 Success\n\n# numResponses: 10\n# numEntries: 5\n")),(0,o.kt)("ol",{start:22},(0,o.kt)("li",{parentName:"ol"},"Create an ldif file called group.ldif that will add an organizational unit with the distinguished name ",(0,o.kt)("strong",{parentName:"li"},"ou=Group"),", ",(0,o.kt)("strong",{parentName:"li"},"dc=ops535"),", ",(0,o.kt)("strong",{parentName:"li"},"dc=com"),". It will act as an organizer for group information."),(0,o.kt)("li",{parentName:"ol"},"Use the /etc/group file and migrate_group.pl to create an ldif file that will add the group entries for ldapuser1 and ldapuser2 to your database."),(0,o.kt)("li",{parentName:"ol"},"Add the group entries for ldapuser1 and ldapuser2 to your database. Use ldapsearch to confirm that they have been added."),(0,o.kt)("li",{parentName:"ol"},"Modify your firewall to allow incoming ldap traffic from your internal zone. Make sure that this change persists past reboot.")),(0,o.kt)("h2",{id:"investigation-2-modifying-openldap-server-configuration-to-use-tls"},"Investigation 2: Modifying OpenLDAP Server Configuration to use TLS"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Warning: This is a good time to make another backup of VM1.")),(0,o.kt)("p",null,"In this investigation we will modify the OpenLDAP server we just created to use TLS to encrypt the data it provides, you should notice that many of these steps are similar to the process of modifying postfix and apache servers to use TLS. Perform these steps on vm1."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Install the openssl package"),(0,o.kt)("li",{parentName:"ol"},"Run the following commands to create a self-signed TLS certificate for your server (make sure you replace the values with ones from your machine):")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Warning: As you run these commands, read the output carefully. If you encounter any errors you must resolve them before continuing to the next command.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"openssl genrsa -des3 -out ca.key 4096\nopenssl req -new -x509 -days 365 -key ca.key -out ca.cert.pem\nopenssl genrsa -out vm1.pcallagh.ops.key 4096\nopenssl req -new -key vm1.pcallagh.ops.key -out vm1.pcallagh.ops.csr\nopenssl x509 -req -in vm1.pcallagh.ops.csr -CA ca.cert.pem -CAkey ca.key -out vm1.pcallagh.ops.crt -CAcreateserial -days 365 -sha256\n")),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},"Copy the certificate, the private key, and the certificte authority file to an appropriate directory (make sure the directory and the files in it are owned by the ldap account and that the directory has permissions set to 0700 and the files have 0600):")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cp ldap.pcallagh.ops.crt ldap.pcallagh.ops.key ca.cert.pem /etc/openldap/certs/\n")),(0,o.kt)("ol",{start:4},(0,o.kt)("li",{parentName:"ol"},"Write an ldif file and add the following values to ",(0,o.kt)("strong",{parentName:"li"},"dn: cn=config")," (again making sure to put in values from your own machine):")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"olcTLSCertificateFile: /etc/openldap/certs/vm1.pcallagh.ops.crt\nolcTLSCertificateKeyFile: /etc/openldap/certs/vm1.pcallagh.ops.key\nolcTLSCACertificateFile: /etc/openldap/certs/ca.cert.pem\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Warning: Read the output of the ldapmodify command carefully. If you encounter any errors you must resolve them before continuing to the next command.")),(0,o.kt)("ol",{start:5},(0,o.kt)("li",{parentName:"ol"},"You can use slapcat to ensure they are set correctly:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'slapcat -b "cn=config" | egrep "Certificate(Key)?File"\n')),(0,o.kt)("ol",{start:6},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Update /etc/openldap/ldap.conf to locate your CACERT, and to indicate that ldaps is now allowed:"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Set the URI parameter to ldaps://vm1.<yourdomain",">",".ops. It is suggested you also include ldapi:/// so local connections are allowed."),(0,o.kt)("li",{parentName:"ul"},"Set TLSCACERT to the absolute path of your certificate authority file (e.g. /etc/openldap/certs/ca.cert.pem)."),(0,o.kt)("li",{parentName:"ul"},"Set TLSCACERTDIR to the directory your certificate authority file is in (e.g. /etc/openldap/certs)."))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Update your firewall to permanently allow ldaps instead of ldap.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Double check that you can still use ldapsearch before continuing to the next investigation."))),(0,o.kt)("h2",{id:"investigation-3-setup-and-configure-openldap-client-through-sssd"},"Investigation 3: Setup and Configure OpenLdap Client Through SSSD"),(0,o.kt)("p",null,"Perform the following steps on vm2:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Install yum-utils")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Install the symas ldap repo")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Install the following packages"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"symas-openldap-clients"),(0,o.kt)("li",{parentName:"ul"},"sssd"),(0,o.kt)("li",{parentName:"ul"},"sssd-ldap"),(0,o.kt)("li",{parentName:"ul"},"sssd-tools"),(0,o.kt)("li",{parentName:"ul"},"openssl-perl"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"If you would like to actually log into the client machines as an ldap user, you need to reconfigure the way the system authentication processes your login. To do this, you will use the authselect tool on the client machine."),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Note: the ldap user does not have home directory on the client unless you provide it via NFS."))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Copy the server's signed certificate onto the client:"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"openssl s_client -connect <hostname or ip address of your ldap server",">",":636 -showcerts < /dev/null | openssl x509 -text > /etc/openldap/certs/cacert.crt"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Set up the SSSD service to use ldap for authentication."),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Start by adding the following settings to /etc/sssd/sssd.conf"),(0,o.kt)("li",{parentName:"ul"},"Note that you may have to create /etc/sssd/sssd.conf yourself. Make sure the file is owned by root:root and that the permissions are 0600.")))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"[sssd]\nservices = nss, pam\nconfig_file_version = 2\ndomains = default\n\n[sudo]\n\n[nss]\nhomedir_substring = /home\n\n[pam]\noffline_credentials_expiration = 60\n\n[domain/default]\nldap_id_use_start_tls = True\ncache_credentials = True\nldap_search_base = <The Base DN from your ldap server>\nid_provider = ldap\nauth_provider = ldap\nchpass_provider = ldap\naccess_provider = ldap\nldap_uri = ldaps://<HOSTNAME or IP ADDRESS of your ldap server>\nldap_chpass_uri = ldaps://<HOSTNAME or IP ADDRESS of your ldap server>\nldap_tls_reqcert = allow\nldap_tls_cacert = <The absolute path of the certificate you copied over from the server>\nldap_tls_cacertdir = <The absolute path to the directory the server's certificate is in>\nldap_search_timeout = 50\nldap_network_timeout = 60\nldap_access_order = filter\nldap_access_filter = (objectClass=posixAccount)\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Now direct sssd to use those changes by running 'authselect select sssd --force'. you need the --force option to make it make changes to several files."),(0,o.kt)("li",{parentName:"ul"},"Test your configuration with 'sssctl config-check' and fix any errors it identifies"),(0,o.kt)("li",{parentName:"ul"},"Once your configuration passes the sssctl check, start and enable sssd.")),(0,o.kt)("ol",{start:7},(0,o.kt)("li",{parentName:"ol"},"Test that your machine is connected to the ldap server by searching for the ldapuser 1 account:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"id ldapuser1\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"You should get something similar to the following (but may not be exactly the same):")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"uid=1002(ldapuser1) gid=1002(ldapuser1) groups=1002(ldapuser1)\n")),(0,o.kt)("ol",{start:8},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"If you want to be able to use commands like ldapsearch from this machine, you will also need to configure ldap in /etc/openldap/ldap.conf. This configuration file should already exist, you just need to modify the parameters to identify the LDAP server and location of its certificate."),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"BASE <base DC from your ldap server",">"),(0,o.kt)("li",{parentName:"ul"},"URI ldaps://<hostname or ip address of your ldap server",">"),(0,o.kt)("li",{parentName:"ul"},"TLS_CACERT <the absolute path of the certificate you downloaded from the server earlier.",">"),(0,o.kt)("li",{parentName:"ul"},"TLS_CACERTDIR <the directory you saved the certificate in",">"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Test your OpenLDAP client with the ldapsearch command."))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"ldapsearch -x 'uid=ldapuser1'\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"You should get results similar to the following:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# extended LDIF\n#\n# LDAPv3\n# base <dc=ops535,dc=com> (default) with scope subtree\n# filter: uid=ldapuser1\n# requesting: ALL\n#\n\n# ldapuser1, People, ops535.com\ndn: uid=ldapuser1,ou=People,dc=ops535,dc=com\nuid: ldapuser1\ncn: ldapuser1\nsn: ldapuser1\nmail: ldapuser1@ops535.com\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\nobjectClass: top\nobjectClass: shadowAccount\nuserPassword:: e2NyeXB0fSQ2JFBCcVFYUm8vJHVnQ0NqQmUwLlpndm1KbDhVMnRWanBkUjhYOWJ\noNE9aMWNsM212NHhmMEh2MUhTRGF2a3h1c084UjNsSXV1Sjdza3JmcXBUUXBiWjZoYmQzZTNCR0Iu\nshadowLastChange: 17120\nshadowMin: 0\nshadowMax: 99999\nshadowWarning: 7\nloginShell: /bin/bash\nuidNumber: 5001\ngidNumber: 5001\nhomeDirectory: /home/ldapuser1\n# search resultsearch: 2\nresult: 0 Success\n# numResponses: 2\n# numEntries: 1\n")),(0,o.kt)("ol",{start:10},(0,o.kt)("li",{parentName:"ol"},"Logout of the client machine, then log back in using the ldapuser1 account."),(0,o.kt)("li",{parentName:"ol"},"Repeat steps 1 through 7 on vm3.")),(0,o.kt)("h2",{id:"investigation-4-update-ldap-configuration"},"Investigation 4: Update LDAP Configuration"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Add the following user accounts to your LDAP server:"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"user name: your seneca id \u2013 password: pick your own"),(0,o.kt)("li",{parentName:"ul"},"rchan \u2013 password: ops535"),(0,o.kt)("li",{parentName:"ul"},"seneca \u2013 password: ops535"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Run the ldapsearch command for each user, and confirm that their information is correct")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Consult the man page on ldappasswd to find out how to change an LDAP user's password. Change seneca's password to seneca.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Consult the man page on ldapdelete to find out how to remove an LDAP user. Delete ldapuser2."))),(0,o.kt)("h2",{id:"completing-the-lab"},"Completing the Lab"),(0,o.kt)("p",null,"You should now have a server providing centralized management of your user information. A service like this will make it much easier to manage and maintain users in your network. When combined with a service like NFS, this centralizes user management and make it much easier to scale your network up."),(0,o.kt)("p",null,"Follow the instructions on blackboard to submit the lab."),(0,o.kt)("h2",{id:"exploration-questions"},"Exploration Questions"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"What changes would you make in NFS to provide remote access to home directories?")))}d.isMDXComponent=!0}}]);