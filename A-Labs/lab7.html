<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-A-Labs/lab7">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-rc.1">
<link rel="icon" href="/OPS535/img/pwa/icon-512x512.png">
<link rel="manifest" href="/OPS535/manifest.json">
<meta name="theme-color" content="#DA291C">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#DA291C">
<link rel="apple-touch-icon" href="/OPS535/img/pwa/icon-192x192.png">
<link rel="mask-icon" href="/OPS535/img/pwa/icon-512x512.png" color="#DA291C">
<meta name="msapplication-TileImage" content="/OPS535/img/pwa/icon-512x512.png">
<meta name="msapplication-TileColor" content="#DA291C">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-rh="true">Lab 7 | OPS535 Course Title</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://Seneca-ICTOER.github.io//OPS535/A-Labs/lab7"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Lab 7 | OPS535 Course Title"><meta data-rh="true" name="description" content="Lab 7"><meta data-rh="true" property="og:description" content="Lab 7"><link data-rh="true" rel="icon" href="/OPS535/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://Seneca-ICTOER.github.io//OPS535/A-Labs/lab7"><link data-rh="true" rel="alternate" href="https://Seneca-ICTOER.github.io//OPS535/A-Labs/lab7" hreflang="en"><link data-rh="true" rel="alternate" href="https://Seneca-ICTOER.github.io//OPS535/A-Labs/lab7" hreflang="x-default"><link rel="stylesheet" href="/OPS535/assets/css/styles.099fe1a9.css">
<link rel="preload" href="/OPS535/assets/js/runtime~main.326f425b.js" as="script">
<link rel="preload" href="/OPS535/assets/js/main.9b6850b2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/OPS535/"><div class="navbar__logo"><img src="/OPS535/img/logo.svg" alt="Seneca College" class="themedImage_ToTc themedImage--light_HNdA"><img src="/OPS535/img/logo-dark.svg" alt="Seneca College" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">OPS535 Course Title</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/OPS535/">Welcome to OPS535</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/OPS535/weekly-schedule">Weekly Schedule</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/OPS535/A-Labs/prelab0">Labs</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/OPS535/A-Labs/prelab0">Pre Lab 0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/OPS535/A-Labs/lab1">Lab 1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/OPS535/A-Labs/lab1-alt">Lab 1 Alternate</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/OPS535/A-Labs/lab2-stage1">Lab 2 Part 1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/OPS535/A-Labs/lab2-stage2">Lab 2 Part 2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/OPS535/A-Labs/lab3-stage1">Lab 3 Part 1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/OPS535/A-Labs/lab3-stage2">Lab 3 Part 2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/OPS535/A-Labs/lab4-home">Lab 4</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/OPS535/A-Labs/lab4-vl">Lab 4 Alternate</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/OPS535/A-Labs/lab5">Lab 5</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/OPS535/A-Labs/lab6">Lab 6</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/OPS535/A-Labs/lab7">Lab 7</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/OPS535/A-Labs/lab8">Lab 8</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/OPS535/B-Assignments/assignment1">Assignments</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/OPS535/C-ExtraResources/required-material-list">Extra Resources</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/OPS535/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Labs</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lab 7</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Lab 7</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="objectives">Objectives<a class="hash-link" href="#objectives" title="Direct link to heading">​</a></h2><p>In this lab you will learn to</p><ul><li>configure postfix (an SMTP server) to use extra security to filter unwanted and suspicious email,</li><li>configure DNS servers to provide extra records to allow mail servers to authenticate incoming mail.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pre-requisites">Pre-Requisites<a class="hash-link" href="#pre-requisites" title="Direct link to heading">​</a></h2><ul><li>Complete Lab 5 (SMTP Lab), and Lab 6 (Routing Lab).</li><li>A working primary DNS server for your domain,</li><li>A basic knowledge of the SMTP protocol (covered in lab 5.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="investigation-1-configuring-postfix-to-use-restrictions">Investigation 1: Configuring Postfix to use Restrictions<a class="hash-link" href="#investigation-1-configuring-postfix-to-use-restrictions" title="Direct link to heading">​</a></h2><p><strong>Referenec</strong></p><ul><li><a href="https://wiki.centos.org/HowTos/postfix_restrictions" target="_blank" rel="noopener noreferrer">Postfix Restrictions</a></li></ul><p><strong>Perform the following steps as a regular user on your VM1</strong></p><ol><li>Using the nc command and the smtp commands you already learned, connect to VM2 and send an email to your root user. Make sure to use the address and hostnames of your own VMs.</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nc</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.6.2 </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">220</span><span class="token plain"> pri-dns.rchan.ops ESMTP Postfix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helo router.rchan.ops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">250</span><span class="token plain"> pri-dns.rchan.ops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mail from: root@router.rchan.ops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">250</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.1</span><span class="token plain">.0 Ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rcpt to:root@pri-dns.rchan.ops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">250</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.1</span><span class="token plain">.5 Ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">354</span><span class="token plain"> End data with </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">CR</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">LF</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">.</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">CR</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">LF</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">250</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.0</span><span class="token plain">.0 Ok: queued as 728CB82ECF6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">221</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.0</span><span class="token plain">.0 Bye</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>Send another email, but this time skip the HELO command.</li></ol><ul><li>Notice that the email is accepted anyway.</li></ul><ol start="3"><li>Edit the /etc/posftfix/main.cf file on VM2 and add the following line (restarting once you have done so):</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">smtpd_helo_required </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>Try sending an email without the HELO command again.<ul><li>Notice that it is immediately rejected.</li><li>This simple step will filter out a surprising amount of spam, as many spam email servers skip the helo step in order to save time when sending massive amounts of email.</li></ul></li><li>Send another email using nc, this time include the helo command, but just put junk in it.<ul><li>smtpd_helo_required doesn’t do anything to check the data in the helo command, it just requires that the connecting server says helo.</li></ul></li><li>Edit the /etc/posftfix/main.cf file on VM2 and add the following line (restarting once you have done so):</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">smtpd_helo_restrictions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> reject_non_fqdn_helo_hostname, permit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Send another email, again using junk in the helo command.</li><li>Notice that the email does get rejected on the basis of the non-fully-qualified hostname, but that it does not happen until you try to use the rcpt to command.</li><li>By default, most rejections will behave this way, gathering as much information as possible about the potentially malicious machine, but preventing it from actually sending the mail.By default, most rejections will behave this way, gathering as much information as possible about the potentially malicious machine, but preventing it from actually sending the mail.</li></ul><ol start="7"><li>We will force rejections to happen immediately, so that you can see the effects of each parameter as we add them.<ul><li>Edit the /etc/posftfix/main.cf file on VM2 and add the following line:</li></ul></li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">smtpd_delay_reject </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> no</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>I am going to stop reminding you to restart the service after changing every parameter, just assume that you should do so anytime you make a change to the configuration file.</li></ul><ol start="8"><li>Try to send your email again.<ul><li>This time you should see the rejection message as soon as you try to use the malformed helo command.
There are other restrictions you can use to filter mail based on the contents of the helo command, but I will let you explore those yourself.</li></ul></li><li>You can also filter mail based on the client machine attempting to connect to you. For example, if it doesn’t have an A or PTR records in DNS, then it almost certainly is not a legitimate email server.<ul><li>Edit the /etc/posftfix/main.cf file on VM2 and add the following line:</li></ul></li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">smtpd_client_restrictions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> reject_unknown_client_hostname, permit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Checking the effects of this might be more complicated, as you will need a machine that doesn’t exist in DNS.<ul><li>Change your VM1&#x27;s 192.168.x.0/24 IP address to a different value, for example, 192.168.x.53. but in the same network.</li><li>Try to connect with nc again. You should get rejected immediately.</li></ul></li><li>Edit the smtpd_client_restrictions line you just added to /etc/posftfix/main.cf file on VM2:</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">smtpd_client_restrictions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> permit_mynetworks, reject_unknown_client_hostname, permit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Try to connect with nc again. This time you are allowed to connect. Because you are in a network defined in the servers mynetworks parameter (that is, your other machine is ‘trusted’), you pass this check and are not subject to the reject_unknown_client_hostname restriction.</li></ul><ol start="10"><li>You can also filter mail based on the sender’s address. For example, if it isn’t a properly formatted email address, it is probably spam.<ul><li>edit the /etc/posftfix/main.cf file on VM2 and add the following line:</li></ul></li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">smtpd_sender_restrictions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> permit_mynetworks, reject_non_fqdn_sender, reject_unknown_sender_domain, permit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>These will reject email if the sender’s address provided in the mail from command is not a fully qualified email address, or if the sending email address does not have an MX record that matches it (this is why your emails to Seneca’s servers in OPS335 often failed).</li><li>Notice the inclusion of two settings we also used in previous restrictions, particularly permit_mynetworks, exempting your own machines from these checks.</li><li>Back on VM1, us the nc command to try to send emails that will pass and fail this restriction.</li></ul><ol start="11"><li>You can filter mail based on the recipient’s address as well. For example, if it isn’t a properly formatted email address, it is possibly spam.<ul><li>Edit the /etc/posftfix/main.cf file on VM2 and add the following line:</li></ul></li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">smtpd_recipient_restrictions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> permit_mynetworks, reject_non_fqdn_recipient, reject_unauth_destination, permit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>These will reject email if the recipient address provided in the rcpt to command is not a fully qualified email address, or if email address it is being sent to would not match your mydestination parameter.</li><li>Notice the inclusion of two settings we also used in previous restrictions, particularly permit_mynetworks, exempting your own machines from these checks.</li><li>Back on VM1, us the nc command to try to send emails that will pass and fail this restriction.</li></ul><ol start="12"><li>There are even restrictions you can place on email that you are relaying to another server. These are governed by the smtpd_relay_restrictions parameter.<ul><li>Edit the /etc/posftfix/main.cf file on VM2 and add the following line:</li></ul></li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">smtpd_relay_restrictions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> reject_unauth_destination, reject_unknown_recipient_domain, permit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>These restrictions will reject that the sending MTA tried to relay through your server if the destination is not in relay_domains, or if the domain has no MX record.</li><li>Note that the reject_unauth_destination setting can show up here and in recipient restrictions. It is the same parameter, but has a different effect.</li></ul><ol start="13"><li>There are more restrictions that you can place on incoming email, but the checks you have added in this investigation will eliminate the vast majority of spam. Anything that is not following the RFCs properly (e.g. skipping the helo command) will be blocked. One thing you will notice about the checks related to DNS records is that they are only checking that the records are there, not that they are correct, or that the server sending us mail actually is the machine it is claiming to be.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="investigation-2-configuring-postfix-to-check-spf-records">Investigation 2: Configuring Postfix to Check SPF Records<a class="hash-link" href="#investigation-2-configuring-postfix-to-check-spf-records" title="Direct link to heading">​</a></h2><p>Perform the following steps as root on your VM2</p><ol><li>Now that you know your email server is restricting incoming (and relayed) mail based on some simple checks, we can add in some information from DNS to improve these checks. For example, we can lookup the DNS records for the domain that seems to be sending us email and check if the ip address of the machine sending us mail matches on of the MX records.</li><li>To see what is not being caught by the restrictions so far, use nc to send an email to your server claiming to be from <a href="mailto:root@rchan.ops" target="_blank" rel="noopener noreferrer">root@rchan.ops</a>.<ul><li>The email goes through because that domain has a properly configured MX record, even though your ip address doesn’t match it.</li><li>Sender Policy Framework (SPF) will fix that.</li></ul></li><li>First we will add the sender policy framework to our mail server:<ul><li>Install the pypolicyd-spf package</li><li>Add spf as a spawnable process. To do so, add the following line to /etc/postfix/master.cf:</li></ul></li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">policyd-spf unix – n n – </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> spawn </span><span class="token assign-left variable" style="color:#36acaa">user</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">nobody </span><span class="token assign-left variable" style="color:#36acaa">argv</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/libexec/postfix/policyd-spf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Finally, add an spf check to the recipient restrictions in /etc/postfix/main.cf:</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">check_policy_service unix:private/policyd-spf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>Now try to send another email to your server, again claiming to be from <a href="mailto:root@rchan.ops" target="_blank" rel="noopener noreferrer">root@rchan.ops</a>.<ul><li>This time it will get blocked, because your server looks up the DNS record and finds out that you are not actually the mail server for that domain.</li></ul></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="investigation-3-configuring-dns-to-provide-spf-records">Investigation 3: Configuring DNS to Provide SPF Records<a class="hash-link" href="#investigation-3-configuring-dns-to-provide-spf-records" title="Direct link to heading">​</a></h2><p>Perform the following steps as root on your VM2(also your primary DNS server)</p><ol><li>SPF depends on the DNS server providing information about which machines are supposed to be sending mail for that domain.</li><li>Each spf record (a specially formatted TXT record) identifies which machines can send mail for the domain, and the machines in that domain, and which machines can not.</li><li>Add the following record to your DNS zone:</li></ol><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ IN TXT &quot;v=spf1 mx -all&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>This specifies that for your domain (@), machines with MX records are allowed to send email, but no other machines should (-all).</li></ul><ol start="4"><li>Now try to send email to your server, claiming to be host.&lt;yourdomain<!-- -->&gt;<!-- -->.ops sending mail from root@&lt;yourdomain<!-- -->&gt;<!-- -->.ops<ul><li>It should now fail, because SPF sees that it doesn’t match.</li></ul></li><li>Try to send that email again, this time claiming to be from root@host.&lt;yourdomain<!-- -->&gt;<!-- -->.ops<ul><li>This gets through the check because the record you added in step three is only for the domain, not the individual machines in it.</li><li>To properly secure mail, you need an spf record for every machine too.</li><li>So add an spf record like the one above for every machine in your domain, replacing the @ with the hostname.<ul><li>If you remember how to use white-space at the beginning of records, you can save yourself some typing.</li></ul></li><li>Now try to send the email claiming to be root@host.&lt;yourdomain<!-- -->&gt;<!-- -->.ops again. This time it should fail.</li></ul></li><li>There is one more SPF record needed to stop someone from spoofing our mail. We need a record for the machines that don’t exist, otherwise someone can just claim to be sending mail from a machine name you don’t have, or a sub-domain.<ul><li>First, send yet another email, this time claiming to be from <a href="mailto:root@.void" target="_blank" rel="noopener noreferrer">root@.void</a>&lt;yourdomain<!-- -->&gt;<!-- -->.ops (or some other machine that doesn’t exist).</li><li>Now add the following record to your zone:</li></ul></li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">*.</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">yourdomain</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">.ops. IN TXT </span><span class="token string" style="color:#e3116c">&quot;v=spf1 mx:&lt;yourdomain&gt;.ops -all&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>This acts as a wildcard and says that any machine in your domain that doesn’t have a record, and any sub-domain that doesn’t have a record should only be sending email from one of your mail servers with the MX records.</li><li>Try sending your spoofed email again. It should no longer work.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="completing-the-lab">Completing the Lab<a class="hash-link" href="#completing-the-lab" title="Direct link to heading">​</a></h2><p>Your DNS and email servers are now cooperating to filter email and prevent malicious email from being sent to your users. They are also providing information making it difficult for others to impersonate your domain. There are more restrictions that can be used, and situations where your spf records would look different, but this is a good basis for any domain.</p><p>Follow the instructions on blackboard to submit the lab.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/Seneca-ICTOER/OERTemplate/tree/main/docs/A-Labs/lab7.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/OPS535/A-Labs/lab6"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Lab 6</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/OPS535/A-Labs/lab8"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Lab 8</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#objectives" class="table-of-contents__link toc-highlight">Objectives</a></li><li><a href="#pre-requisites" class="table-of-contents__link toc-highlight">Pre-Requisites</a></li><li><a href="#investigation-1-configuring-postfix-to-use-restrictions" class="table-of-contents__link toc-highlight">Investigation 1: Configuring Postfix to use Restrictions</a></li><li><a href="#investigation-2-configuring-postfix-to-check-spf-records" class="table-of-contents__link toc-highlight">Investigation 2: Configuring Postfix to Check SPF Records</a></li><li><a href="#investigation-3-configuring-dns-to-provide-spf-records" class="table-of-contents__link toc-highlight">Investigation 3: Configuring DNS to Provide SPF Records</a></li><li><a href="#completing-the-lab" class="table-of-contents__link toc-highlight">Completing the Lab</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">OPS535 Course Title</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/OPS535/">Contents</a></li><li class="footer__item"><a href="#" id="pwa-button" class="footer__link-item" hidden>Install as an App</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Seneca College.</div></div></div></footer></div>
<script src="/OPS535/assets/js/runtime~main.326f425b.js"></script>
<script src="/OPS535/assets/js/main.9b6850b2.js"></script>
</body>
</html>